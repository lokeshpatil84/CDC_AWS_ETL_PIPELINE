name: CI - Code Quality

on:
  push:
    branches: [dev, staging, main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  TERRAFORM_VERSION: "1.10.0"

jobs:
  # ---------------------------------------------------------------------------
  # Python Code Quality
  # ---------------------------------------------------------------------------
  python-quality:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort bandit pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Check Python Syntax
        run: |
          find . -name "*.py" -not -path "./.venv/*" -not -path "./env/*" -print0 | \
            xargs -0 -I {} python -m py_compile {} && \
            echo "✓ Python syntax check passed"

      - name: Code Formatting (Black)
        run: |
          black --check --diff . || {
            echo "Code not formatted. Run: black ."
            exit 1
          }

      - name: Import Sorting (isort)
        run: |
          isort --check-only --diff . || {
            echo "Imports not sorted. Run: isort ."
            exit 1
          }

      - name: Security Lint (Bandit)
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -ll || {
            echo "Security issues found. Check bandit-report.json"
            exit 1
          }

      - name: Flake8 Lint
        run: |
          # Critical errors only (fail on these)
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Full report (don't fail, just warn)
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run Tests with Coverage
        run: |
          if [ -d tests ] || [ -d test ]; then 
            pytest --cov=. --cov-report=xml --cov-report=term -v
          else 
            echo "ℹ No tests directory found - skipping pytest"
            # Don't fail if no tests, but create empty coverage
            echo "0" > coverage.txt
          fi

      - name: Upload Coverage Report
        uses: codecov/codecov-action@v3
        if: hashFiles('coverage.xml') != ''
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # ---------------------------------------------------------------------------
  # Terraform Quality
  # ---------------------------------------------------------------------------
  terraform-quality:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Install TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.50.0

      - name: Terraform Format Check
        run: |
          if [ -d terraform ]; then 
            echo "Checking Terraform formatting..."
            terraform -chdir=terraform fmt -check -recursive
          else
            echo "ℹ No terraform directory found"
          fi

      - name: Terraform Validate
        if: hashFiles('terraform/*.tf') != ''
        run: |
          cd terraform
          echo "Initializing Terraform (local mode)..."
          terraform init -backend=false -input=false
          
          echo "Validating Terraform..."
          terraform validate
          
          echo "✓ Terraform validation passed"

      - name: TFLint
        if: hashFiles('terraform/*.tf') != ''
        run: |
          cd terraform
          tflint --init || true
          tflint --format compact || {
            echo "TFLint found issues"
            exit 1
          }

      - name: Checkov Security Scan
        if: hashFiles('terraform/*.tf') != ''
        uses: bridgecrewio/checkov-action@master
        with:
          directory: terraform
          framework: terraform
          output_format: sarif
          output_file_path: reports/checkov.sarif
          soft_fail: true

  # ---------------------------------------------------------------------------
  # Docker Quality
  # ---------------------------------------------------------------------------
  docker-quality:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install YAML Lint
        run: pip install yamllint

      - name: YAML Syntax Check
        run: |
          if [ -f docker-compose.yml ]; then 
            yamllint -d relaxed docker-compose.yml
          fi
          
          if [ -f docker-compose.yaml ]; then 
            yamllint -d relaxed docker-compose.yaml
          fi

      - name: Validate Docker Compose
        run: |
          if [ -f docker-compose.yml ]; then 
            docker compose config > /dev/null && echo "✓ Docker Compose valid"
          else
            echo "ℹ No docker-compose.yml found"
          fi

      - name: Hadolint (Dockerfile Linter)
        if: hashFiles('**/Dockerfile') != ''
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ./Dockerfile
          recursive: true
          failure-threshold: error

  # ---------------------------------------------------------------------------
  # Project Structure Validation
  # ---------------------------------------------------------------------------
  project-structure:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate Directory Structure
        run: |
          echo "Checking project structure..."
          
          # Required files with descriptions
          declare -A required_files=(
            ["requirements.txt"]="Python dependencies"
            ["docker-compose.yml"]="Local development environment"
            ["terraform/main.tf"]="Infrastructure as Code"
            ["glue/kafka_to_bronze.py"]="Streaming ingestion job"
            ["glue/bronze_to_silver.py"]="SCD Type 2 transformation"
            ["glue/silver_to_gold.py"]="Business aggregations"
            ["airflow/dags/cdc_pipeline_dag.py"]="Orchestration DAG"
            ["sql/init.sql"]="Database schema"
          )
          
          missing=()
          
          for file in "${!required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "  ✓ $file (${required_files[$file]})"
            else
              echo "  ✗ $file MISSING (${required_files[$file]})"
              missing+=("$file")
            fi
          done
          
          if [ ${#missing[@]} -gt 0 ]; then
            echo ""
            echo "::error::${#missing[@]} required file(s) missing!"
            exit 1
          fi
          
          echo ""
          echo "✓ All required files present"

      - name: Check File Permissions
        run: |
          # Ensure no secrets in code
          if grep -r "AKIA[0-9A-Z]{16}" . --include="*.py" --include="*.tf" 2>/dev/null; then
            echo "::error::Potential AWS Access Key found!"
            exit 1
          fi
          
          if grep -r "private_key\|private_key_path" . --include="*.tf" | grep -v "var\." | grep -v "#"; then
            echo "::warning::Check for hardcoded private keys"
          fi

  # ---------------------------------------------------------------------------
  # CI Status Summary
  # ---------------------------------------------------------------------------
  ci-status:
    runs-on: ubuntu-latest
    needs: [python-quality, terraform-quality, docker-quality, project-structure]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: Check CI Status
        run: |
          echo "CI Status Report"
          echo "=========================================="
          echo "Python Quality:    ${{ needs.python-quality.result }}"
          echo "Terraform Quality: ${{ needs.terraform-quality.result }}"
          echo "Docker Quality:    ${{ needs.docker-quality.result }}"
          echo "Project Structure: ${{ needs.project-structure.result }}"
          echo "=========================================="
          
          if [ "${{ needs.python-quality.result }}" != "success" ]; then
            echo "::error::Python quality checks failed"
            exit 1
          fi
          
          if [ "${{ needs.terraform-quality.result }}" != "success" ]; then
            echo "::error::Terraform quality checks failed"
            exit 1
          fi
          
          if [ "${{ needs.docker-quality.result }}" != "success" ]; then
            echo "::error::Docker quality checks failed"
            exit 1
          fi
          
          if [ "${{ needs.project-structure.result }}" != "success" ]; then
            echo "::error::Project structure validation failed"
            exit 1
          fi
          
          echo "✓ All CI checks passed!"